
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Function to check if user is an admin
    function isAdmin() {
      return request.auth != null && (
        request.auth.token.email == "beherajashobanta892@gmail.com" ||
        request.auth.token.email == "admin@example.com"
      );
    }

    // ----------------------------
    // Contacts Collection
    // ----------------------------
    match /contacts/{docId} {
      // Admins can do anything
      allow read, write: if isAdmin();

      // Any authenticated user can create a contact, but must own it
      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;
      
      // A non-admin user can only read/update/delete their own contacts
      allow get, update, delete: if request.auth != null && get(/databases/$(database)/documents/contacts/$(docId)).data.ownerId == request.auth.uid;
    }
    
    // Non-admins can only query for their own contacts
    match /contacts/{docId} {
        allow list: if request.auth != null && !isAdmin() && request.query.get("ownerId") == request.auth.uid;
    }


    // ----------------------------
    // Reviews Collection
    // ----------------------------
    match /reviews/{docId} {
      // Anyone can submit a review
      allow create: if true; 
      
      // Only admins can read, update or delete reviews
      allow read, update, delete: if isAdmin();
    }

    // ----------------------------
    // Default Rule
    // ----------------------------
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
